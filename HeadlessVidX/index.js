const express=require("express"),childProcess=require("child_process"),{chromium:chromium,firefox:firefox,webkit:webkit}=require("playwright-extra"),StealthPlugin=require("puppeteer-extra-plugin-stealth"),{format:format}=require("date-fns"),UserAgent=require("user-agents"),https=require("https"),http=require("http"),fs=require("fs"),path=require("path"),{URL:URL}=require("url"),axios=require("axios"),{exec:exec}=require("child_process"),WebSocket=require("ws"),{Buffer:Buffer}=require("buffer"),app=express(),stealthy=StealthPlugin(),defaultPort=3202,port=process.env.PORT||3202,VIDEO_TMP_DIR=path.join(__dirname,"videos_tmp"),PlaywrightFirefoxManager=require("./playwright-firefox");let FIREFOX_EXECUTABLE_PATH=null;const{promises:fsp}=require("fs"),{join:join,resolve:resolve,sep:sep}=require("path");async function launchBrowserByType(e,t={}){const{showBrowser:r=!1,proxy:n=null,stealth:o=!1}=t,s={headless:!r,ignoreHTTPSErrors:!0},a=["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-infobars","--disable-blink-features=AutomationControlled","--ignore-certificate-errors","--ignore-certificate-errors-spki-list","--allow-insecure-localhost","--disable-features=IsolateOrigins,site-per-process","--flag-switches-begin --disable-site-isolation-trials --flag-switches-end","--disable-web-security","--disable-features=CrossSiteDocumentBlockingIfIsolating"];let i;switch(r||a.push("--window-size=1920,1080"),n&&a.push(`--proxy-server=${n}`),e){case"Chrome":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"chrome",args:a});break;case"Chrome Beta":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"chrome-beta",args:a});break;case"Chrome Dev":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"chrome-dev",args:a});break;case"Chrome Canary":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"chrome-canary",args:a});break;case"Edge":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"msedge",args:a});break;case"Edge Beta":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"msedge-beta",args:a});break;case"Edge Dev":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"msedge-dev",args:a});break;case"Edge Canary":o&&chromium.use(stealthy),i=await chromium.launch({...s,channel:"msedge-canary",args:a});break;case"Chromium":o&&chromium.use(stealthy),i=await chromium.launch({...s,args:a});break;case"Firefox":const t={headless:!r,ignoreHTTPSErrors:!0,executablePath:FIREFOX_EXECUTABLE_PATH||process.env.FIREFOX_BIN||void 0};if(o&&(t.firefoxUserPrefs={"dom.webdriver.enabled":!1,"media.navigator.enabled":!0,"media.peerconnection.enabled":!0,"permissions.default.image":1,"dom.webnotifications.enabled":!0}),r||(t.args=["-headless"]),n){t.firefoxUserPrefs||(t.firefoxUserPrefs={});const e=n.split(":"),r=e[0],o=parseInt(e[1]||"8080");t.firefoxUserPrefs["network.proxy.type"]=1,t.firefoxUserPrefs["network.proxy.http"]=r,t.firefoxUserPrefs["network.proxy.http_port"]=o,t.firefoxUserPrefs["network.proxy.ssl"]=r,t.firefoxUserPrefs["network.proxy.ssl_port"]=o}i=await firefox.launch(t);break;case"WebKit":o&&webkit.use(stealthy),i=await webkit.launch({...s,args:a});break;default:throw new Error(`Unknown browser type: ${e}`)}return i}async function hardenBrowserContext(e){await e.addInitScript(()=>{try{try{delete Navigator.prototype.webdriver}catch(e){}try{delete navigator.webdriver}catch(e){}}catch{}try{const e=Object.getOwnPropertyDescriptor(Navigator.prototype,"plugins")?.get,t=Object.getOwnPropertyDescriptor(Navigator.prototype,"languages")?.get;e?Object.defineProperty(Navigator.prototype,"plugins",{get:e,configurable:!0,enumerable:!1}):Object.defineProperty(Navigator.prototype,"plugins",{get:()=>[],configurable:!0,enumerable:!1}),t?Object.defineProperty(Navigator.prototype,"languages",{get:t,configurable:!0,enumerable:!1}):Object.defineProperty(Navigator.prototype,"languages",{get:()=>["en-US","en"],configurable:!0,enumerable:!1})}catch(e){}try{window.chrome||(window.chrome={runtime:{}})}catch(e){}try{const e=WebGLRenderingContext&&WebGLRenderingContext.prototype&&WebGLRenderingContext.prototype.getParameter;e&&(WebGLRenderingContext.prototype.getParameter=function(t){try{if(37445===t)return"Intel Inc.";if(37446===t)return"Intel Iris OpenGL Engine"}catch(e){}return e.apply(this,arguments)})}catch(e){}try{const e=window.navigator.permissions;if(e&&e.query){const t=e.query.bind(e);e.query=e=>e&&"notifications"===e.name?Promise.resolve({state:Notification.permission}):t(e)}}catch(e){}try{for(const e in window)if(e&&e.startsWith&&e.startsWith("cdc_"))try{delete window[e]}catch(e){}try{delete window.domAutomationController}catch(e){}}catch(e){}try{new MutationObserver(()=>{document.querySelectorAll("iframe[sandbox]").forEach(e=>{try{e.removeAttribute("sandbox")}catch(e){}})}).observe(document,{childList:!0,subtree:!0})}catch(e){}})}async function cleanupOldVideos(){const e=resolve(VIDEO_TMP_DIR);if(!await fsp.stat(e).catch(()=>null))return;const t=async e=>{const r=[];for(const n of await fsp.readdir(e,{withFileTypes:!0})){const o=join(e,n.name);if(n.isDirectory())r.push(...await t(o));else if(n.isFile()&&n.name.toLowerCase().endsWith(".webm")){const{mtimeMs:e}=await fsp.stat(o);r.push({p:o,m:e})}}return r},r=await t(e);if(r.length<=50)return;r.sort((e,t)=>t.m-e.m);const n=r.slice(50);for(const e of n)await fsp.unlink(e.p).catch(t=>console.error("[cleanupOldVideos] could not delete",e.p,t.message));console.log(`[cleanupOldVideos] kept 50, deleted ${n.length}`)}const KEEPALIVE_URL=`http://localhost:${port}/ping`;let lastCleanup=0;const CLEANUP_INTERVAL=216e5;function keepAliveLoop(){!async function(){for(console.log("[keepalive] Running initial cleanup..."),await cleanupOldVideos(),lastCleanup=Date.now();;){let e=null,t=null;try{e=await launchBrowserByType("Firefox",{showBrowser:!1,proxy:null,stealth:!1});const r=await e.newContext();await r.addInitScript(()=>{try{delete Navigator.prototype.webdriver,delete navigator.webdriver,Object.defineProperty(Navigator.prototype,"webdriver",{get:()=>!1,configurable:!0,enumerable:!1})}catch{}});const n=await r.newPage(),o=async()=>{try{await n.goto(KEEPALIVE_URL,{waitUntil:"domcontentloaded",timeout:15e3}),console.log(`[keepalive] ping @ ${(new Date).toISOString()}`);const e=Date.now();e-lastCleanup>216e5&&(console.log("[keepalive] Running scheduled cleanup..."),await cleanupOldVideos(),lastCleanup=e)}catch(e){throw console.error("[keepalive] ping failed:",e.message),e}};await o(),t=setInterval(async()=>{try{await o()}catch(e){t&&clearInterval(t)}},12e4),await new Promise(t=>{e.on("disconnected",()=>{console.log("[keepalive] browser disconnected"),t()})}),console.warn("[keepalive] browser closed — restarting…")}catch(e){console.error("[keepalive] error:",e.message)}finally{if(t&&clearInterval(t),e)try{await e.close()}catch(e){}}console.log("[keepalive] waiting 5 seconds before restart..."),await new Promise(e=>setTimeout(e,5e3))}}()}const server=http.createServer(app),wss=new WebSocket.Server({server:server});async function saveLatestVideo(){try{const e=await fs.promises.readdir(VIDEO_TMP_DIR,{withFileTypes:!0}),t=[];for(const r of e)if(r.isFile()&&r.name.toLowerCase().endsWith(".webm"))t.push(path.join(VIDEO_TMP_DIR,r.name));else if(r.isDirectory()){(await fs.promises.readdir(path.join(VIDEO_TMP_DIR,r.name))).filter(e=>e.toLowerCase().endsWith(".webm")).forEach(e=>t.push(path.join(VIDEO_TMP_DIR,r.name,e)))}if(!t.length)return null;const r=(await Promise.all(t.map(async e=>({f:e,mtime:(await fs.promises.stat(e)).mtimeMs})))).sort((e,t)=>t.mtime-e.mtime)[0].f;for(let e=0;e<30;e++){const{size:e}=await fs.promises.stat(r);if(e>0)break;await new Promise(e=>setTimeout(e,100))}return r}catch(e){return console.error("saveRecordedVideo failed:",e),null}}const logFilePath=path.resolve(__dirname,"logs/combined.log"),origSpawn=childProcess.spawn;childProcess.spawn=function(e,t,r={}){return r.windowsHide=!0,origSpawn(e,t,r)},process.on("unhandledRejection",(e,t)=>{console.error("[WARN] Unhandled promise rejection:",e)});const logDir=path.dirname(logFilePath);fs.existsSync(logDir)||fs.mkdirSync(logDir,{recursive:!0});let logStream=fs.createWriteStream(logFilePath,{flags:"a"}),clients=[];const logs=new Map;let currentRequestId=null;var requestId,thisHost,thisPort;const originalConsoleLog=console.log;console.log=(...e)=>{const t=e.join(" "),r=`${format(new Date,"MM/dd/yyyy hh:mm:ss a")} - ${t}\n`;if(originalConsoleLog.apply(console,e),currentRequestId){const e=logs.get(currentRequestId)||[];e.push(r.trim()),logs.set(currentRequestId,e),requestId&&broadcastLogs(currentRequestId)}logStream.write(r)};const broadcastLogs=e=>{const t=logs.get(e);if(t){const r=t.join("\n");clients.forEach(e=>{e.readyState===WebSocket.OPEN&&e.send(r)}),logStream.write(r+"\n"),logs.delete(e)}};wss.on("connection",e=>{console.log("Client connected"),clients.push(e),e.on("close",()=>{console.log("Client disconnected"),clients=clients.filter(t=>t!==e)})}),wss.on("error",e=>{console.log("WebSocket Server Error:",e)});const MAX_LOG_SIZE=10485760;function checkAndTruncateLog(){fs.stat(logFilePath,(e,t)=>{e?console.error("Error checking log file size:",e):t.size>10485760&&(console.log("Truncating log file as it exceeds maximum size"),fs.truncate(logFilePath,0,e=>{e?console.error("Error truncating log file:",e):console.log("Log file truncated successfully")}))})}setInterval(checkAndTruncateLog,6e4),(async()=>{await checkAndSetupFirefox()||(console.error("Firefox not ready — exiting."),process.exit(1)),keepAliveLoop()})(),downloadEasyList();const blockedDomains=loadBlockedDomains(path.join(__dirname,"blacklist","adblock-easylist.txt")),easylistCSS=(()=>{try{const e=fs.readFileSync(path.join(__dirname,"blacklist","adblock-easylist.txt"),"utf8"),t=[];e.split("\n").forEach(e=>{if((e=e.trim())&&!e.startsWith("!")&&!e.startsWith("[")&&e.includes("##")){const r=e.split("##"),n=r[0],o=r[1];o&&!o.includes("+js(")&&(n&&""!==n||t.push(o))}});const r=t.filter(Boolean).map(e=>e.replace(/([\\])/g,"\\$1")).join(",");return r?`${r}{display:none!important;visibility:hidden!important;opacity:0!important;pointer-events:none!important;}`:""}catch(e){return console.error("Error building CSS rules:",e),""}})();function extractScriptlets(e){const t={};return e.split("\n").forEach(e=>{if(!(e=e.trim())||e.startsWith("!"))return;if(!e.includes("##+js("))return;const[r,n]=e.split("##"),o=n.match(/\+js\(([^)]+)\)/);if(!o)return;const s=o[1].split(",").map(e=>e.trim().replace(/^['"]|['"]$/g,""));let a="";switch(s[0]){case"set":case"set-constant":if(s.length>=3){const e=s[1],t=s[2];a=generateSetConstant(e,t)}break;case"abort-on-property-read":case"aopr":s[1]&&(a=generateAbortOnPropertyRead(s[1]));break;case"abort-on-property-write":case"aopw":s[1]&&(a=generateAbortOnPropertyWrite(s[1]));break;case"abort-current-inline-script":case"acis":s[1]&&(a=generateAbortCurrentInlineScript(s[1],s[2]));break;case"prevent-setTimeout":a=generatePreventSetTimeout(s[1],s[2]);break;case"prevent-setInterval":a=generatePreventSetInterval(s[1],s[2]);break;case"remove-attr":s[1]&&s[2]&&(a=generateRemoveAttr(s[1],s[2]));break;case"remove-class":s[1]&&s[2]&&(a=generateRemoveClass(s[1],s[2]))}if(a){(r?r.split(",").map(e=>e.trim()):["*"]).forEach(e=>{t[e]||(t[e]=[]),t[e].push(a)})}}),t}function generateSetConstant(e,t){let r;switch(t){case"true":r="true";break;case"false":r="false";break;case"null":r="null";break;case"undefined":r="undefined";break;case"noopFunc":r="function(){}";break;case"trueFunc":r="function(){return true}";break;case"falseFunc":r="function(){return false}";break;default:r=isNaN(t)?`"${t.replace(/"/g,'\\"')}"`:t}return`\n    (function() {\n      const prop = "${e}";\n      const value = ${r};\n      const parts = prop.split('.');\n      let obj = window;\n      \n      for (let i = 0; i < parts.length - 1; i++) {\n        const part = parts[i];\n        if (!(part in obj)) {\n          Object.defineProperty(obj, part, {\n            value: {},\n            writable: false,\n            enumerable: false,\n            configurable: true\n          });\n        }\n        obj = obj[part];\n      }\n      \n      const lastPart = parts[parts.length - 1];\n      Object.defineProperty(obj, lastPart, {\n        value: value,\n        writable: false,\n        enumerable: false,\n        configurable: false\n      });\n    })();\n  `}function generateAbortOnPropertyRead(e){return`\n    (function() {\n      const prop = "${e}";\n      const parts = prop.split('.');\n      let obj = window;\n      \n      for (let i = 0; i < parts.length - 1; i++) {\n        const part = parts[i];\n        if (!(part in obj)) {\n          obj[part] = {};\n        }\n        obj = obj[part];\n      }\n      \n      const lastPart = parts[parts.length - 1];\n      Object.defineProperty(obj, lastPart, {\n        get() {\n          throw new ReferenceError("Property read blocked: " + prop);\n        },\n        set() {},\n        enumerable: false,\n        configurable: false\n      });\n    })();\n  `}function generateAbortOnPropertyWrite(e){return`\n    (function() {\n      const prop = "${e}";\n      const parts = prop.split('.');\n      let obj = window;\n      \n      for (let i = 0; i < parts.length - 1; i++) {\n        const part = parts[i];\n        if (!(part in obj)) {\n          obj[part] = {};\n        }\n        obj = obj[part];\n      }\n      \n      const lastPart = parts[parts.length - 1];\n      let value;\n      Object.defineProperty(obj, lastPart, {\n        get() { return value; },\n        set(v) {\n          throw new Error("Property write blocked: " + prop);\n        },\n        enumerable: false,\n        configurable: false\n      });\n    })();\n  `}function generateAbortCurrentInlineScript(e,t){return`\n    (function() {\n      const pattern = "${e||""}";\n      const search = "${t||""}";\n      const originalEval = window.eval;\n      \n      window.eval = new Proxy(originalEval, {\n        apply(target, thisArg, args) {\n          const code = args[0];\n          if (typeof code === 'string') {\n            if (pattern && code.includes(pattern)) {\n              if (!search || code.includes(search)) {\n                console.log('Blocked inline script containing:', pattern);\n                return undefined;\n              }\n            }\n          }\n          return Reflect.apply(target, thisArg, args);\n        }\n      });\n    })();\n  `}function generatePreventSetTimeout(e,t){return`\n    (function() {\n      const pattern = ${e?`"${e}"`:"null"};\n      const delay = ${t||"null"};\n      const originalSetTimeout = window.setTimeout;\n      \n      window.setTimeout = function(fn, ms, ...args) {\n        const fnStr = fn.toString();\n        if (pattern && fnStr.includes(pattern)) {\n          if (delay === null || ms == delay) {\n            console.log('Blocked setTimeout:', pattern);\n            return -1;\n          }\n        }\n        return originalSetTimeout.apply(this, arguments);\n      };\n    })();\n  `}function generatePreventSetInterval(e,t){return`\n    (function() {\n      const pattern = ${e?`"${e}"`:"null"};\n      const delay = ${t||"null"};\n      const originalSetInterval = window.setInterval;\n      \n      window.setInterval = function(fn, ms, ...args) {\n        const fnStr = fn.toString();\n        if (pattern && fnStr.includes(pattern)) {\n          if (delay === null || ms == delay) {\n            console.log('Blocked setInterval:', pattern);\n            return -1;\n          }\n        }\n        return originalSetInterval.apply(this, arguments);\n      };\n    })();\n  `}function generateRemoveAttr(e,t){return`\n    (function() {\n      const attr = "${e}";\n      const selector = "${t}";\n      \n      function removeAttrs() {\n        try {\n          const elements = document.querySelectorAll(selector);\n          elements.forEach(el => {\n            if (el.hasAttribute(attr)) {\n              el.removeAttribute(attr);\n            }\n          });\n        } catch(e) {}\n      }\n      \n      if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', removeAttrs);\n      } else {\n        removeAttrs();\n      }\n      \n      // Also observe for dynamic content\n      const observer = new MutationObserver(removeAttrs);\n      observer.observe(document.body, {\n        childList: true,\n        subtree: true,\n        attributes: true,\n        attributeFilter: [attr]\n      });\n    })();\n  `}function generateRemoveClass(e,t){return`\n    (function() {\n      const className = "${e}";\n      const selector = "${t}";\n      \n      function removeClasses() {\n        try {\n          const elements = document.querySelectorAll(selector);\n          elements.forEach(el => {\n            el.classList.remove(className);\n          });\n        } catch(e) {}\n      }\n      \n      if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', removeClasses);\n      } else {\n        removeClasses();\n      }\n      \n      // Also observe for dynamic content\n      const observer = new MutationObserver(removeClasses);\n      observer.observe(document.body, {\n        childList: true,\n        subtree: true,\n        attributes: true,\n        attributeFilter: ['class']\n      });\n    })();\n  `}const scriptletMap=extractScriptlets(fs.readFileSync(path.join(__dirname,"blacklist","adblock-easylist.txt"),"utf8"));function getPortFromFile(){try{const e=path.join(__dirname,"listening-port.txt"),t=fs.readFileSync(e,"utf8"),r=parseInt(t.trim(),10);if(!isNaN(r)&&r>0&&r<=65535)return r;throw new Error(`Invalid port number in listening-port.txt: ${t}`)}catch(e){return console.error(`Error reading port from listening-port.txt: ${e.message}.`),savePortToFile(3202),null}}function savePortToFile(e){const t=path.join(__dirname,"listening-port.txt");try{fs.writeFileSync(t,e.toString(),"utf8"),console.log(`Port number ${e} saved to listening-port.txt`)}catch(e){console.error(`Error writing port to listening-port.txt: ${e.message}.`)}}app.use(express.json());const sitesFilePath=path.join(__dirname,"dict/sites.json"),checkBrowserInstalled=async e=>{try{switch(e.toLowerCase()){case"firefox":await firefox.launch();break;case"chrome":await chromium.launch({channel:"chrome"});break;case"chrome beta":await chromium.launch({channel:"chrome-beta"});break;case"chrome dev":await chromium.launch({channel:"chrome-dev"});break;case"chrome canary":await chromium.launch({channel:"chrome-canary"});break;case"edge":await chromium.launch({channel:"msedge"});break;case"edge beta":await chromium.launch({channel:"msedge-beta"});break;case"edge dev":await chromium.launch({channel:"msedge-dev"});break;case"edge canary":await chromium.launch({channel:"msedge-canary"});break;case"webkit":await webkit.launch();break;case"chromium":await chromium.launch();break;default:return!1}return!0}catch(e){return console.log("Error during browser check:",e.message),await delay(100),!1}},dummyData={timeout:15e3,selectors:"",stealth:!0,showBrowser:!1,frame:!1,ref:"",block:"",proxy:"",adblock:!0,bruteClick:!1,mustContain:"",notContain:"",blistjs:!1,cusUseragent:"random",browserType:"Firefox"};async function startTask(e,t,r,n,o,s,a,i,l,c,u,d,p,h,g,m,f,w,y,b=!0,v="json",x=!1){let k,S=null;try{const I=!0,O=t,L=r?parseInt(r):3e4,F=n?n.split(","):[],A=s,U=a,D=i,q=l?l.split(","):[],M=c||"",B=u;let W;W=!1!==w&&"false"!==w;const N=o,H=g,V=p?p.split(","):[],z=h?h.split(","):[],X=m&&"random"!==m.trim().toLowerCase()&&0!==m.trim().length?m.trim():(new UserAgent).toString(),G=f||"Firefox";async function E(){if(k)try{await k.close()}catch(e){console.error(e)}if(x){const e=await saveLatestVideo();return e&&(S=e,console.log(`Saved recording → ${e}`)),e}}let Y=!1;async function $(){return Y?null:(Y=!0,await E())}function _(e){return new Promise(function(t){setTimeout(t,e)})}try{let J,K;k=await async function(){try{return k=await launchBrowserByType(G,{showBrowser:A,proxy:M,stealth:N}),I&&console.log(`Using ${G} Browser - Stealth: ${N}`),k}catch(e){return console.log("Error during browser launch:",e.message),await _(100),C(!1,`The selected browser (${G}) is not installed. Please install it to proceed.`,null,null,d,!0)}}(),/Mobile|Android/i.test(X)?(J={width:390,height:844},K=3):/Tablet|iPad/i.test(X)?(J={width:768,height:1024},K=2):(J={width:1920,height:1080},K=1);const Z={userAgent:X,viewport:J,deviceScaleFactor:K,locale:"en-US",timezoneId:"America/New_York"};x&&(Z.recordVideo={dir:VIDEO_TMP_DIR,size:J});const Q=await k.newContext(Z),ee=await Q.newPage();B&&easylistCSS&&await ee.addInitScript(e=>{const t=document.createElement("style");if(t.textContent=e,t.setAttribute("data-adblock","cosmetic"),document.documentElement)document.documentElement.appendChild(t);else{new MutationObserver((e,r)=>{document.documentElement&&(document.documentElement.appendChild(t),r.disconnect())}).observe(document,{childList:!0,subtree:!0})}if("undefined"!=typeof window){const t=()=>{const t=e.split("{")[0].split(","),r=[];t.forEach(e=>{try{const t=e.trim();t&&document.querySelectorAll(t).length>0&&r.push(t)}catch(e){}}),r.length>0&&console.log("[AdBlock][CSS] Hidden elements:",r.length)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}},easylistCSS),await blockPopups(Q,ee,I),await ee.addInitScript(({w:e,h:t,d:r})=>{Object.defineProperty(window,"devicePixelRatio",{get:()=>r,configurable:!0});for(const r of["width","height","availWidth","availHeight"])Object.defineProperty(screen,r,{get:()=>r.includes("width")?e:t,configurable:!0});const n=window.matchMedia;window.matchMedia=e=>{if(/device-pixel-ratio|resolution/.test(e)){const t=parseFloat(e.match(/[\d.]+/)||1),n=/dppx/.test(e)?r:96*r;return{matches:e.includes("min")?n>=t:e.includes("max")?n<=t:n===t,media:e,onchange:null,addListener:()=>{},removeListener:()=>{}}}return n.call(window,e)}},{w:J.width,h:J.height,d:K}),await ee.addInitScript(()=>{const e=Object.getOwnPropertyDescriptor(Navigator.prototype,"plugins")?.get,t=Object.getOwnPropertyDescriptor(Navigator.prototype,"languages")?.get;e&&Object.defineProperty(Navigator.prototype,"plugins",{get:e,enumerable:!0,configurable:!1}),t&&Object.defineProperty(Navigator.prototype,"languages",{get:t,enumerable:!0,configurable:!1});try{delete Navigator.prototype.webdriver,delete navigator.webdriver,Object.defineProperty(navigator,"webdriver",{get:()=>{},configurable:!0,enumerable:!1})}catch{}(()=>{const e=Symbol("navProxyFlag");if(navigator[e])return;const t=new Proxy(navigator,{get:(e,t)=>"webdriver"===t?void 0:Reflect.get(e,t),has:(e,t)=>"webdriver"!==t&&Reflect.has(e,t),ownKeys:e=>Reflect.ownKeys(e).filter(e=>"webdriver"!==e),getOwnPropertyDescriptor:(e,t)=>"webdriver"===t?void 0:Reflect.getOwnPropertyDescriptor(e,t)});Object.defineProperty(window,"navigator",{value:t,configurable:!1,enumerable:!1,writable:!1}),Object.defineProperty(t,e,{value:!0})})(),(()=>{const e=()=>{};try{Object.defineProperty(navigator,"webdriver",{get:()=>{},configurable:!0,enumerable:!1})}catch(e){}try{const t=window.WorkerNavigator||{};t.prototype&&Object.defineProperty(t.prototype,"webdriver",{get:e,set:void 0,enumerable:!1,configurable:!1})}catch(e){}})(),window.chrome=window.chrome||{},window.chrome.runtime=window.chrome.runtime||{};const r=window.navigator.permissions?.query;r&&(window.navigator.permissions.query=e=>"notifications"===e?.name?Promise.resolve({state:Notification.permission}):r.call(window.navigator.permissions,e));const n=WebGLRenderingContext?.prototype.getParameter;n&&(WebGLRenderingContext.prototype.getParameter=function(e){return 37445===e?"Intel Inc.":37446===e?"Intel Iris OpenGL Engine":n.call(this,e)});for(const e of Object.keys(window))if(/^cdc_/.test(e))try{delete window[e]}catch{}try{delete window.domAutomationController}catch{}}),D&&await ee.setExtraHTTPHeaders({Referer:D}),ee.on("dialog",async e=>{I&&console.log("Blocking dialog:",e.type()),await e.dismiss()});let te=!1,re=!1,ne=null,oe=null,se=null;async function C(e,t,r,n,o,s,a=!1,i=null,l="json"){if(s&&"function"==typeof s.status){if(!re){re=!0;const c=a?"error":"ok";let u=[];u.push(t||"");const d=(e,t)=>{if("string"==typeof t){const r=t.trim();r&&"null"!==r.toLowerCase()&&u.push(`${e}="${r}"`)}};d("User-Agent",o),d("Referer",r),d("Origin",n);const p=Buffer.from(u.join("|")).toString("base64"),h=`http://${thisHost}:${thisPort}/proxy?url=${encodeURIComponent(t)}&data=${encodeURIComponent(p)}`,{protocol:g,headers:{host:m}}=s.req,f=`${g}://${m}/play?url=${encodeURIComponent(e)}`,w={status:c,url:void 0!==t&&t,Referer:void 0!==r?r:null,Origin:void 0!==n?n:null,"User-Agent":void 0!==o?o:null,"Content-Type":void 0!==i?i:null,streamUrl:!1===a?f:null,proxy:!1===a?h:null};"redirect"!==l||a?(s.json(w),console.log(`Response status: ${c} - Returned: ${JSON.stringify(w,null,2)}`)):(s.redirect(302,h),console.log(`Response status: ${c} - Redirected to: ${h}`)),y&&setImmediate(()=>{broadcastLogs(y)})}await $()}else console.error("sendResponse called with invalid res object")}const ae=path.resolve(__dirname,"blacklist/javascripts-loading.txt"),ie=fs.readFileSync(ae,"utf-8").split("\n").map(e=>e.trim()).filter(Boolean),le=path.resolve(__dirname,"blacklist/javascripts-contains.txt"),ce=fs.readFileSync(le,"utf-8").split("\n").map(e=>e.trim()).filter(Boolean),ue=path.resolve(__dirname,"blacklist/block-all-request.txt"),de=fs.readFileSync(ue,"utf-8").split("\n").map(e=>e.trim()).filter(Boolean),pe=[".jpg",".jpeg",".png",".gif",".bmp",".webp"];function R(e,t){return 0===t.length||t.some(t=>e.includes(t))}function P(e,t){return 0===t.length||t.every(t=>!e.includes(t))}async function j(e,t){try{let r,n=!1;try{r=await axios.head(e,{headers:t})}catch(o){if(!o.response||![400,403,405].includes(o.response.status))throw o;console.log(`HEAD not allowed (${o.response.status}), trying GET...`),r=await axios.get(e,{headers:t,responseType:"stream",maxRedirects:3,validateStatus:e=>e<500}),n=!0}let o=(r.headers&&r.headers["content-type"]||"").toLowerCase();if(o.includes("video"))return console.log(`URL is a video (Content-Type: ${o}): ${e}`),{isValid:!0,contentType:o};if(o.includes("mpegurl"))return console.log(`URL is HLS (Content-Type: ${o}): ${e}`),{isValid:!0,contentType:o};n||(console.log("Checking body for HLS markers..."),r=await axios.get(e,{headers:t,responseType:"stream",maxRedirects:3,validateStatus:e=>e<500}));let s="";const a=4096,i=r.data;for await(const e of i)if(s+=e.toString("utf8"),s.length>=a)break;return/#EXTM3U/i.test(s)||/#EXTINF/i.test(s)?(console.log(`URL is HLS (body markers found): ${e}`),o="application/vnd.apple.mpegurl",{isValid:!0,contentType:o}):/(\.m3u8($|\?))|(\.mp4($|\?))|(\.ts($|\?))|(hls)|(playlist)/i.test(e)?(console.log(`URL accepted by pattern: ${e}`),o=/\.mp4/i.test(e)?"video/mp4":/\.ts/i.test(e)?"video/MP2T":"application/vnd.apple.mpegurl",{isValid:!0,contentType:o}):(console.log(`URL is not a video or HLS stream: ${e}`),{isValid:!1,contentType:o||null})}catch(t){return console.log(`Failed to check URL: ${e}, Error: ${t.message}`),{isValid:!1,contentType:null}}}async function T(e,t,r){let n;try{n=e.page?e.page():e}catch(t){n=e}if(await e.evaluate(()=>{const e=e=>{const t=window.getComputedStyle(e),r=parseInt(t.zIndex,10);"fixed"===t.position&&(!isNaN(r)&&r>=9999||"none"===t.pointerEvents)&&e.remove()};document.querySelectorAll("*").forEach(e),new MutationObserver(t=>{t.forEach(t=>t.addedNodes.forEach(e))}).observe(document.documentElement,{childList:!0,subtree:!0})}).catch(e=>console.log("Pop killer failed:",e)),t.includes("||")){const n=t.split("||").map(e=>e.trim());try{return void await Promise.any(n.map(t=>T(e,t,r)))}catch(e){return void console.log(`All OR-options failed for ${t}`)}}try{if(t.includes(",")&&!t.startsWith("javascript:")){const n=t.split(",").map(e=>e.trim());for(const t of n)try{let n=!1;try{await e.evaluate(()=>!0)}catch(e){n=!0}if(n)return void console.log("Context closed, skipping remaining selectors");await T(e,t,r),await new Promise(e=>setTimeout(e,500))}catch(e){console.log(`Skipping failed selector: ${t} (${e.message})`);continue}return}if(t.startsWith("javascript:")){const r=t.slice(11).split(",");for(const t of r)try{console.log(`Executing JavaScript: ${t}`),await e.evaluate(t)}catch(e){console.log(`Skipping failed JS: ${t} (${e.message})`)}return}let o;t.startsWith("//")||t.startsWith("./")||t.startsWith("(")?(console.log(`Using XPath selector: ${t}`),o=e.locator(`xpath=${t}`)):(console.log(`Using CSS selector: ${t}`),o=e.locator(t));try{const r=await o.elementHandle({timeout:2e3});let n;r&&(n=await r.contentFrame()),n&&(console.log("Element is inside an iframe. Switching to iframe context."),o=(e=n).locator(t))}catch(e){}let s=!1;try{await async function(e,t){try{await e.evaluate(e=>{if(!window.__highlightOverlay){const e=document.createElement("div");e.id="__highlight_container",e.style.cssText="\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          pointer-events: none;\n          z-index: 2147483647;\n        ",document.body?document.body.appendChild(e):document.documentElement.appendChild(e),window.__highlightOverlay=e}const t=function(e){try{return e.startsWith("//")||e.startsWith("./")||e.startsWith("(")?document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue:document.querySelector(e)}catch(t){return console.log(`Failed to find element with selector: ${e}`,t),null}}(e);if(!t)return void console.log(`Element not found for selector: ${e}`);const r=t.getBoundingClientRect(),n=window.pageXOffset||document.documentElement.scrollLeft,o=window.pageYOffset||document.documentElement.scrollTop;window.__highlightOverlay.innerHTML="";const s=document.createElement("div");s.style.cssText=`\n        position: absolute;\n        left: ${r.left+n}px;\n        top: ${r.top+o}px;\n        width: ${r.width}px;\n        height: ${r.height}px;\n        border: 3px solid #ff0080;\n        box-shadow: 0 0 20px #ff0080, inset 0 0 20px rgba(255, 0, 128, 0.3);\n        animation: highlightPulse 1.5s ease-in-out infinite;\n        pointer-events: none;\n      `;const a=document.createElement("div");a.style.cssText=`\n        position: absolute;\n        left: ${r.left+n+r.width/2-20}px;\n        top: ${r.top+o+r.height/2-20}px;\n        width: 40px;\n        height: 40px;\n        background: radial-gradient(circle, rgba(255,0,128,0.8) 0%, transparent 70%);\n        border-radius: 50%;\n        animation: highlightRipple 1.5s ease-out;\n        pointer-events: none;\n      `;const i=document.createElement("div"),l=e.length>60?e.substring(0,60)+"...":e;if(i.textContent=`Clicking: ${l}`,i.style.cssText=`\n        position: absolute;\n        left: ${Math.max(10,r.left+n)}px;\n        top: ${Math.max(10,r.top+o-30)}px;\n        background: linear-gradient(90deg, #ff0080, #00ff00);\n        color: white;\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-family: monospace;\n        font-size: 12px;\n        font-weight: bold;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n        max-width: 300px;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        pointer-events: none;\n        z-index: 2147483648;\n      `,!document.querySelector("#__highlight_styles")){const e=document.createElement("style");e.id="__highlight_styles",e.textContent="\n          @keyframes highlightPulse {\n            0%, 100% { \n              transform: scale(1);\n              opacity: 1;\n            }\n            50% { \n              transform: scale(1.02);\n              opacity: 0.7;\n            }\n          }\n          @keyframes highlightRipple {\n            0% {\n              transform: scale(0);\n              opacity: 1;\n            }\n            100% {\n              transform: scale(3);\n              opacity: 0;\n            }\n          }\n        ",document.head.appendChild(e)}window.__highlightOverlay.appendChild(s),window.__highlightOverlay.appendChild(a),window.__highlightOverlay.appendChild(i);try{t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}catch(e){t.scrollIntoView(!0)}const c=t.style.backgroundColor,u=t.style.transition;t.style.transition="background-color 0.3s",t.style.backgroundColor="rgba(255, 0, 128, 0.3)",setTimeout(()=>{window.__highlightOverlay&&(window.__highlightOverlay.innerHTML=""),t.style.backgroundColor=c||"",t.style.transition=u||""},2e3)},t)}catch(e){console.log(`Highlight failed for ${t}: ${e.message}`)}}(e,t),await new Promise(e=>setTimeout(e,300))}catch(e){console.log(`Highlight skipped: ${e.message}`)}try{await o.waitFor({state:"visible",timeout:5e3}),await o.scrollIntoViewIfNeeded(),await o.focus(),await o.click(),s=!0,console.log(`✅ Successfully clicked using locator: ${t}`)}catch(e){console.log(`Locator click failed: ${e.message}`)}if(!s)try{await e.evaluate(e=>{let t;if(e.startsWith("//")||e.startsWith("./")||e.startsWith("(")){t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}else t=document.querySelector(e);return!!t&&(t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.dispatchEvent(new MouseEvent("mouseover",{bubbles:!0})),"function"==typeof t.click?t.click():t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),!0)},t),s=!0,console.log(`✅ Successfully clicked using evaluate: ${t}`)}catch(e){console.log(`Evaluate click failed: ${e.message}`)}if(!s&&!t.startsWith("//")&&!t.startsWith("./"))try{await e.$eval(t,e=>e.click()),s=!0,console.log(`✅ Successfully clicked using $eval: ${t}`)}catch(e){console.log(`$eval failed: ${e.message}`)}if(!s)try{await o.focus(),await e.keyboard.press("Enter"),s=!0,console.log("✅ Successfully clicked using keyboard Enter")}catch(e){console.log(`Keyboard Enter failed: ${e.message}`)}if("by-element"!==r||s){if(r&&"false"!==r&&!1!==r)try{let t,o,a=await e.evaluate(()=>({width:window.innerWidth||document.documentElement.clientWidth||1920,height:window.innerHeight||document.documentElement.clientHeight||1080}));switch(r){case"upper-left":t=50,o=50;break;case"upper-center":t=a.width/2,o=50;break;case"upper-right":t=a.width-50,o=50;break;case"center-left":t=50,o=a.height/2;break;case"center":t=a.width/2,o=a.height/2;break;case"center-right":t=a.width-50,o=a.height/2;break;case"lower-left":t=50,o=a.height-50;break;case"lower-center":t=a.width/2,o=a.height-50;break;case"lower-right":t=a.width-50,o=a.height-50;break;default:console.log(`Unknown bruteClick value: ${r}`)}if(void 0!==t&&void 0!==o){t=Math.max(0,Math.min(Math.floor(t),Math.max(0,a.width-1))),o=Math.max(0,Math.min(Math.floor(o),Math.max(0,a.height-1))),console.log(`Clicking at coordinates (${t}, ${o})`);try{await n.mouse.move(t,o),await n.mouse.click(t,o),s=!0,console.log(`✅ Successfully clicked using brute click ${r}`)}catch(e){console.log(`Mouse operation failed: ${e.message}`)}}}catch(e){console.log(`BruteClick coordinate failed: ${e.message}`)}}else try{const r=await e.evaluate(e=>{let t;if(e.startsWith("//")||e.startsWith("./")||e.startsWith("(")){t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}else t=document.querySelector(e);if(!t)throw new Error(`Element not found for selector: ${e}`);const r=t.getBoundingClientRect();return{x:r.left+window.scrollX,y:r.top+window.scrollY,width:r.width,height:r.height}},t),o=r.x+r.width/2,a=r.y+r.height/2;console.log(`Clicking at element position (${o}, ${a})`);try{await n.mouse.click(o,a),s=!0,console.log(`✅ Successfully clicked using brute click by-element: ${t}`)}catch(e){console.log(`Mouse click failed: ${e.message}`)}}catch(e){console.log(`BruteClick by-element failed: ${e.message}`)}s||console.log(`⚠️ All click methods failed for selector: ${t}`)}catch(e){e.message.includes("Element is not visible")||e.message.includes("Timeout")?console.log(`❌ Selector ${t} was not found within the timeout period.`):console.error("❌ Error during page interaction:",e.message)}}ee.on("response",async t=>{if(re)return;const r=t.request(),n=r.url(),o=t.headers()["content-type"];if(I&&console.log(`Response URL: ${n}, Content-Type: ${o}`),t.url()===O){const e=t.status();I&&console.log(`Response status for initial URL: ${e}`),e>=400&&C(!1,null,null,null,null,d,!0)}if(o&&(o.includes("video")||o.includes("mpegurl"))&&!n.includes(".ts")&&R(n,V)&&P(n,z)){te=n;const t=r.headers();ne=t.referer||null,oe=t.origin||null,se=t["user-agent"]||null;const s=(await j(n,t)).contentType||o;C(e,te,ne,oe,se,d,!1,s,v)}}),ee.on("requestfailed",e=>{if(e.url()===O){const t=e.failure();I&&console.log(`Request failed for initial URL: ${t.errorText}`),C(!1,null,null,null,null,d,!0)}}),await ee.route("**/*",async t=>{if(re)return;const r=t.request(),n=r.url(),o=r.headers(),s=r.resourceType();I&&console.log(`Handling request: ${r.method()} ${n}, Resource Type: ${s}`);try{const r=new URL(n);if(B&&blockedDomains.has(r.hostname))return I&&console.log(`Ad Blocked by EasyList: ${n}`),void t.abort();const a=de.find(e=>n.includes(e));if(a)return I&&console.log(`Blocked by block-all-request.txt: ${n}, Blocked String: ${a}`),void t.abort();if("script"===s){const e=ie.find(e=>{try{if(e.startsWith("/")&&e.endsWith("/")){const t=e.slice(1,-1);return new RegExp(t).test(n)}return n.includes(e)}catch(t){return n.includes(e)}});if(e)return I&&console.log(`Blocked by javascripts-loading.txt: ${n}, Blocked String: ${e}`),void t.abort();if(H&&ce.length>0)try{const e=new AbortController,r=setTimeout(()=>e.abort(),5e3),s=await fetch(n,{signal:e.signal,headers:{"User-Agent":o["user-agent"]||"Mozilla/5.0",Referer:o.referer||"",Accept:"*/*"}});if(clearTimeout(r),s.ok){const e=await s.text(),r=ce.find(t=>{try{if(t.startsWith("/")&&t.endsWith("/")){const r=t.slice(1,-1);return new RegExp(r,"i").test(e)}return e.toLowerCase().includes(t.toLowerCase())}catch(r){return e.includes(t)}});if(r)return I&&console.log(`Blocked by javascripts-contains.txt: ${n}, Contains: "${r}"`),void t.abort()}}catch(e){I&&("AbortError"===e.name?console.log(`Timeout fetching script for content check: ${n}`):console.log(`Could not fetch script for content check: ${n}, Error: ${e.message}`))}}if(q.includes(s))return I&&console.log(`Blocking resource type: ${s}, URL: ${n}`),void t.abort();if(t.continue(),I&&console.log(`Intercepted URL: ${n}`),!te&&(n.includes(".mp4")||n.includes(".m3u8"))&&!function(e){return pe.some(t=>e.toLowerCase().includes(t))}(n)){const t=await j(n,o);if(t.isValid){if(R(n,V)&&P(n,z)){te=n;const r=o.referer||null,s=o.origin||null,a=o["user-agent"]||null;C(e,te,r,s,a,d,!1,t.contentType)}}else I&&console.log(`URL does not point to a valid video resource: ${n}`)}}catch(e){I&&console.log(`Error handling request: ${r.method()} ${n}, Resource Type: ${s}, Error: ${e.message}`),t.continue()}}),setTimeout(()=>{te||C(!1,null,null,null,null,d,!0)},L),await async function(){try{if(await _(500),U){await async function(e,t){await e.setContent(`\n\t\t\t\t\t\t\t\t\t<!DOCTYPE html>\n\t\t\t\t\t\t\t\t\t<html>\n\t\t\t\t\t\t\t\t\t\t<head>\n\t\t\t\t\t\t\t\t\t\t\t<meta charset="utf-8">\n\t\t\t\t\t\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\t\t\t\t\t\thtml, body {\n\t\t\t\t\t\t\t\t\t\t\t\t\tmargin: 0;\n\t\t\t\t\t\t\t\t\t\t\t\t\theight: 100%;\n\t\t\t\t\t\t\t\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tiframe {\n\t\t\t\t\t\t\t\t\t\t\t\t\tborder: none;\n\t\t\t\t\t\t\t\t\t\t\t\t\theight: 100%;\n\t\t\t\t\t\t\t\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t</style>\n\t\t\t\t\t\t\t\t\t\t</head>\n\t\t\t\t\t\t\t\t\t\t<body>\n\t\t\t\t\t\t\t\t\t\t\t<iframe id="iframe" src="${t}" referrerpolicy="origin"></iframe>\n\t\t\t\t\t\t\t\t\t\t</body>\n\t\t\t\t\t\t\t\t\t</html>\n\t\t\t\t\t\t\t\t`,{waitUntil:"domcontentloaded"});const r=await e.waitForSelector("#iframe"),n=await r.contentFrame();return await n.waitForLoadState("load"),n}(ee,O);const e=await ee.waitForSelector("#iframe",{visible:!0,timeout:L}),t=await e.contentFrame();for(const e of F)await T(t,e,w)}else{await ee.goto(O,{waitUntil:"domcontentloaded",timeout:L});for(const e of F)await T(ee,e,w)}}catch(e){e.message.includes("Timeout")?I&&console.log("Operation timed out:",e):I&&console.error("Error during page interaction:",e.message),C(!1,null,null,null,null,d,!0)}}()}catch(he){he.message.includes("Timeout")?I&&console.log("Timeout occurred while starting the browser or during initialization:",he):I&&console.error("Error starting browser:",he.message),d.headersSent||d.status(500).send("Error launching Playwright"),await E()}console.log(`Extracting video from URL: ${t}`),console.log({timeout:r,selectors:n,stealth:o,showBrowser:s,frame:a,ref:i,block:l,proxy:c,adblock:u,mustContain:p,notContain:h,blistjs:g,cusUseragent:m,browserType:f,bruteClick:w}),await new Promise(e=>setTimeout(e,r||1e3)),d.headersSent||d.json({status:"ok",message:"Video extracted successfully"})}catch(ge){d.headersSent||d.status(500).json({status:"error",error:"Failed to extract video"}),await $()}finally{return await $(),S}}app.get("/client",(e,t)=>{t.sendFile(path.join(__dirname,"pages","logging.html"))});const RECORDING_CT="video/webm",VIDEO_ROOT=path.resolve(VIDEO_TMP_DIR),b64urlEncode=e=>Buffer.from(e,"utf8").toString("base64url"),b64urlDecode=e=>Buffer.from(e,"base64url").toString("utf8");async function listAllRecordings(e){const t=await fs.promises.readdir(e,{withFileTypes:!0}),r=[];for(const n of t){const t=path.join(e,n.name);if(n.isFile()&&n.name.toLowerCase().endsWith(".webm")){const e=await fs.promises.stat(t);r.push({abs:t,rel:path.relative(VIDEO_ROOT,t),mtime:e.mtimeMs,bytes:e.size})}else if(n.isDirectory()){const e=await fs.promises.readdir(t);for(const n of e)if(n.toLowerCase().endsWith(".webm")){const e=path.join(t,n),o=await fs.promises.stat(e);r.push({abs:e,rel:path.relative(VIDEO_ROOT,e),mtime:o.mtimeMs,bytes:o.size})}}}return r.sort((e,t)=>t.mtime-e.mtime),r}function absolutify(e,t){if(/^(?:[a-z][a-z0-9+.-]*:(?=\/\/)|\/\/)/i.test(e))return e;let r,n;try{r=new URL(t)}catch(e){throw new Error(`Invalid base URL: ${t}`)}try{n=new URL(e,r.href)}catch(r){throw new Error(`Cannot resolve path "${e}" relative to "${t}"`)}if(!n.search&&r.search&&n.origin===r.origin){const e=n.hash;n.search=r.search.slice(1),n.hash=e}return n.href}function rewriteUrls(e,t,r,n){const o=e.split("\n"),s=[];let a=!1;for(let e of o){let o=e.trimEnd();if(!o||o.startsWith("#")){const e=o.match(/URI="([^"]+)"/i);if(e){const s=absolutify(e[1],t);if(!s.startsWith(r)){let t=`${r}?url=${encodeURIComponent(s)}&data=${encodeURIComponent(n)}`;o.includes("#EXT-X-KEY")&&(t+="&key=true"),o=o.replace(e[1],t)}}s.push(o),a=o.includes("#EXT-X-STREAM-INF");continue}const i=absolutify(o,t);if(i.startsWith(r))s.push(i);else{const e=a?"url":"url2";s.push(`${r}?${e}=${encodeURIComponent(i)}&data=${encodeURIComponent(n)}`)}a=!1}return s.join("\n")}async function fetchContent(e,t={}){const r=[502,503],n=async(o={},s=1)=>{try{const r=await axios.get(e,{responseType:"stream",maxRedirects:4,headers:{...t,...o},validateStatus:e=>e<500});return{stream:r.data,statusCode:r.status,headers:r.headers,contentType:r.headers["content-type"]||"",finalUrl:r.request.res.responseUrl||e}}catch(e){const o=e.response?.status;if((r.includes(o)||t.Range||t.Origin||t.Referer)&&s<3){const e={...t};return delete e.Range,delete e.Origin,delete e.Referer,console.warn(`[fetchContent] retry #${s} on status ${o}`),await new Promise(e=>setTimeout(e,500*s)),n(e,s+1)}throw e}};return n()}async function blockPopups(e,t,r=!1){e.on("page",e=>{e!==t&&process.nextTick(async()=>{r&&console.log("Popup detected and closed!");try{e.isClosed()||await e.close({runBeforeUnload:!1})}catch(e){r&&console.warn("Popup already closed:",e.message)}})})}function downloadEasyList(){const e=path.join(__dirname,"blacklist","adblock-easylist.txt"),t=path.dirname(e);fs.existsSync(t)||fs.mkdirSync(t,{recursive:!0});const r=fs.createWriteStream(e);https.get("https://easylist-downloads.adblockplus.org/easylist.txt",e=>{200===e.statusCode?(e.pipe(r),r.on("finish",()=>{r.close(()=>{console.log("Updated Adblock easylist.")})})):console.error(`Failed to download EasyList. Status code: ${e.statusCode}`)}).on("error",e=>{console.error(`Error downloading EasyList: ${e.message}`)})}function loadBlockedDomains(e){const t=fs.readFileSync(e,"utf8"),r=/^\|\|([^\^]+)\^/gm,n=new Set;let o;for(;null!==(o=r.exec(t));)n.add(o[1]);return n}async function checkAndSetupFirefox(){console.log("Checking Firefox installation...");try{const e=new PlaywrightFirefoxManager({SILENT:!1,VERBOSE:!1}),t=await e.initialize();if(t.success){if(t.path&&"system"!==t.path){const e=path.join(__dirname,"ms-playwright");process.env.PLAYWRIGHT_BROWSERS_PATH=e;const r=path.join(e,`firefox-${t.version}`);let n=null;if("win32"===process.platform){const e=[path.join(r,"firefox","firefox.exe"),path.join(r,"firefox.exe")];for(const t of e)if(fs.existsSync(t)){n=t;break}}else if("linux"===process.platform){const e=[path.join(r,"firefox","firefox"),path.join(r,"firefox-bin","firefox"),path.join(r,"firefox")];for(const t of e)if(fs.existsSync(t)){n=t;break}}else if("darwin"===process.platform){const e=[path.join(r,"Firefox.app","Contents","MacOS","firefox"),path.join(r,"firefox")];for(const t of e)if(fs.existsSync(t)){n=t;break}}if(t.path&&"system"!==t.path&&!n)return console.error("❌ Local Firefox executable not found."),!1;FIREFOX_EXECUTABLE_PATH=n,process.env.FIREFOX_BIN=n,console.log(`✅ Firefox ready (local): ${FIREFOX_EXECUTABLE_PATH||"path found"}`),console.log(`   Environment: PLAYWRIGHT_BROWSERS_PATH=${process.env.PLAYWRIGHT_BROWSERS_PATH}`)}else console.log("✅ Firefox ready (system managed)");return!0}return console.error("❌ Firefox setup failed:",t.error),!1}catch(e){return console.error("❌ Firefox check error:",e.message),!1}}app.get("/get-browser-recordings",async(e,t)=>{try{if(!fs.existsSync(VIDEO_ROOT))return t.json({success:!0,recordings:[]});const e=(await listAllRecordings(VIDEO_ROOT)).map(e=>{const t=b64urlEncode(e.rel);return{id:t,url:`/browser-recording/${t}`,display:format(new Date(e.mtime),"hh:mm:ss a - MM/dd/yyyy"),iso:new Date(e.mtime).toISOString(),bytes:e.bytes}});t.set({"Cache-Control":"no-store, no-cache, must-revalidate, max-age=0",Pragma:"no-cache","CDN-Cache-Control":"no-store","Surrogate-Control":"no-store"}),t.json({success:!0,recordings:e})}catch(e){console.error("get-browser-recordings failed:",e),t.status(500).json({success:!1,error:"Internal server error"})}}),app.get("/browser-recording/:id",async(e,t)=>{try{const r=b64urlDecode(e.params.id),n=path.resolve(path.join(VIDEO_ROOT,r));if(!n.startsWith(VIDEO_ROOT+path.sep)&&n!==VIDEO_ROOT)return t.status(400).send("Invalid recording id");if(!fs.existsSync(n))return t.status(404).send("Recording not found");const o=(await fs.promises.stat(n)).size,s=e.headers.range;if(t.setHeader("Cache-Control","no-store, no-cache, must-revalidate, max-age=0"),t.setHeader("Pragma","no-cache"),t.setHeader("Accept-Ranges","bytes"),s){const e=s.match(/bytes=(\d*)-(\d*)/),r=e&&e[1]?parseInt(e[1],10):0,a=e&&e[2]?parseInt(e[2],10):Math.max(o-1,0);return r>=o||a>=o||r>a?(t.setHeader("Content-Range",`bytes */${o}`),t.status(416).end()):(t.status(206),t.setHeader("Content-Type","video/webm"),t.setHeader("Content-Range",`bytes ${r}-${a}/${o}`),t.setHeader("Content-Length",a-r+1),fs.createReadStream(n,{start:r,end:a}).pipe(t))}t.status(200),t.setHeader("Content-Type","video/webm"),t.setHeader("Content-Length",o),fs.createReadStream(n).pipe(t)}catch(e){console.error("browser-recording failed:",e),t.status(500).send("Internal server error")}}),app.get("/latest-run.webm",async(e,t)=>{try{const e=await fs.promises.readdir(VIDEO_TMP_DIR,{withFileTypes:!0}),r=[];for(const t of e)if(t.isFile()&&t.name.toLowerCase().endsWith(".webm"))r.push(path.join(VIDEO_TMP_DIR,t.name));else if(t.isDirectory()){(await fs.promises.readdir(path.join(VIDEO_TMP_DIR,t.name))).filter(e=>e.toLowerCase().endsWith(".webm")).forEach(e=>r.push(path.join(VIDEO_TMP_DIR,t.name,e)))}if(!r.length)return t.status(404).send("No recording yet.");const n=(await Promise.all(r.map(async e=>({f:e,mtime:(await fs.promises.stat(e)).mtimeMs})))).sort((e,t)=>t.mtime-e.mtime)[0].f;t.set({"Content-Type":"video/webm","Cache-Control":"no-store, no-cache, must-revalidate, max-age=0",Pragma:"no-cache",Expires:"0","CDN-Cache-Control":"no-store","Surrogate-Control":"no-store"}),t.sendFile(n)}catch(e){console.error("Failed to serve latest-run.webm:",e),t.status(500).send("Internal server error")}}),app.get("/ready",(e,t)=>t.sendFile(path.join(__dirname,"pages/initialized.html"))),app.get("/please-wait",(e,t)=>t.sendFile(path.join(__dirname,"pages/please-wait.html"))),app.post("/extract-video",async(e,t)=>{const{url:r,timeout:n,selectors:o,stealth:s,showBrowser:a,frame:i,ref:l,block:c,proxy:u,adblock:d,mustContain:p,notContain:h,blistjs:g,cusUseragent:m,browserType:f,bruteClick:w,trainRequest:y=!1}=e.body,b=r;requestId=Date.now().toString(),currentRequestId=requestId,logs.set(requestId,[]);const v=`${e.protocol}://${e.get("host")}${e.originalUrl}`,x=new URL(v);thisHost=x.hostname,thisPort=x.port||(e.secure?443:80);try{const e=await startTask(b,r,n,o,s,a,i,l,c,u,d,t,p,h,g,m,f,w,requestId,!0,"json",y);e&&y&&console.log("Trainer video finalized:",e),t.headersSent||t.status(200).json({status:"success",message:"Task completed successfully"})}catch(e){t.headersSent||t.status(500).json({status:"error",error:e.message})}}),app.get("/get-video",async(e,t)=>{requestId=!1;const r=`${e.protocol}://${e.get("host")}${e.originalUrl}`,n=new URL(r);thisHost=n.hostname,thisPort=n.port||(e.secure?443:80);const o=e.query.url,s=e.query.type||"json";if(!o)return t.status(400).json({status:"error",error:"URL parameter is required"});const a=o,i=(new Date).toLocaleString();console.log(`Request was received at ${i}.`);const l=new URL(o).host;let c={};if(fs.existsSync(sitesFilePath)){const e=fs.readFileSync(sitesFilePath);c=JSON.parse(e)}const u=c.find(e=>e.site===l);u&&console.log(`Profile loaded for Site: ${u.site}`);const d=u&&u.submitted_data?u.submitted_data:dummyData;let{timeout:p,selectors:h,stealth:g,showBrowser:m,frame:f,ref:w,block:y,proxy:b,adblock:v,mustContain:x,notContain:k,blistjs:S,cusUseragent:E,browserType:$,bruteClick:_}=d;try{await startTask(a,o,p,h,g,m,f,w,y,b,v,t,x,k,S,E,$,_,!1,!1,s,!1)}catch(e){t.headersSent||t.status(500).json({status:"error",error:e.message})}const C=(new Date).toLocaleString();console.log(`Finished at ${C}.`)}),app.get("/play",async(e,t)=>{const r=e.query.url;if(!r)return t.status(400).json({status:"error",error:"url parameter is required"});try{const n=`${e.protocol}://${e.get("host")}`,o=await axios.get(`${n}/get-video`,{params:{url:r}});return"ok"===o.data?.status&&o.data.proxy?t.redirect(302,o.data.proxy):t.status(502).json(o.data)}catch(e){console.error("Play route error:",e.message||e),t.status(500).json({status:"error",error:"play route failed"})}}),app.get("/ping",async(e,t)=>{try{t.json({message:"Pong",status:"Server is running"})}catch(e){console.error("Error handling ping request:",e),t.status(500).json({message:"Internal Server Error"})}}),app.use(express.static(__dirname)),app.use(express.urlencoded({extended:!0})),app.post("/trainer/request",(e,t)=>{const r=e.body,n=new URLSearchParams(r).toString();t.redirect(`/trainer/request.html?${n}`)}),app.post("/trainer/add_site",(e,t)=>{const{site:r,submitted_data:n}=e.body;if(!r||!n)return console.error("Invalid data received:",e.body),t.status(400).json({status:"error",message:"Invalid data."});n.cusUseragent||(n.cusUseragent="random"),!0===n.showBrowser&&(n.showBrowser=!1);const o=["uniqueId","trainRequest"];for(const e of o)e in n&&delete n[e];const s=path.join(__dirname,"dict","sites.json"),a=fs.existsSync(s)?JSON.parse(fs.readFileSync(s,"utf8")):[];if(!Array.isArray(a))return console.error("Data read from file is not an array"),t.status(500).json({status:"error",message:"Server error."});const i=a.findIndex(e=>e.site===r);-1!==i?a[i]={site:r,submitted_data:n}:a.push({site:r,submitted_data:n});try{fs.writeFileSync(s,JSON.stringify(a,null,2)),t.json({status:"success",message:"Site added successfully!"})}catch(e){console.error("Error writing to file:",e),t.status(500).json({status:"error",message:"Failed to save data."})}}),app.get("/trainer/get_site",(e,t)=>{const r=e.query.hostname,n=path.join(__dirname,"dict","sites.json");fs.readFile(n,"utf8",(e,n)=>{if(e)return console.error(e),t.status(500).json({error:"Internal server error"});try{const e=JSON.parse(n).find(e=>e.site===r);if(!e)return t.status(404).json({error:"Site not found"});t.json({success:!0,site:e})}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}})}),app.get("/trainer/get_all_sites",(e,t)=>{const r=path.join(__dirname,"dict","sites.json");fs.readFile(r,"utf8",(e,r)=>{if(e)return console.error(e),t.status(500).json({error:"Internal server error"});try{const e=JSON.parse(r).map(e=>e.site);t.json({success:!0,sites:e})}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}})}),app.get("/trainer/get_default_values",(e,t)=>{t.json({success:!0,defaultValues:dummyData})}),app.delete("/trainer/delete_site",(e,t)=>{const r=e.query.hostname,n=path.join(__dirname,"dict","sites.json");fs.readFile(n,"utf8",(e,o)=>{if(e)return console.error(e),t.status(500).json({error:"Internal server error"});try{let e=JSON.parse(o);const s=e.length;if(e=e.filter(e=>e.site!==r),e.length===s)return t.status(404).json({error:"Site not found"});fs.writeFile(n,JSON.stringify(e,null,2),"utf8",e=>{if(e)return console.error(e),t.status(500).json({error:"Internal server error"});t.json({success:!0,message:"Site deleted successfully"})})}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}})}),app.get("/trainer-form",(e,t)=>{t.sendFile(path.join(__dirname,"pages/train-sites.html"))}),app.get("/trainer",(e,t)=>{t.sendFile(path.join(__dirname,"pages/train-main.html"))}),app.get("/training-guide",(e,t)=>{t.sendFile(path.join(__dirname,"pages/training-guide.html"))}),app.get("/ready",(e,t)=>{t.sendFile(path.join(__dirname,"pages/initialized.html"))}),app.get("/waiting",(e,t)=>{t.sendFile(path.join(__dirname,"pages/please-wait.html"))}),app.get("/",(e,t)=>{t.sendFile(path.join(__dirname,"pages/home.html"))}),server.listen(port,"0.0.0.0",()=>{console.log(`Server running at http://0.0.0.0:${port}/`),console.log(`WebSocket server is listening on port ${port}`)}),app.get("/get-page",async(e,t)=>{const r=e.query.url;if(!r)return t.status(400).send("URL is required");let n;try{n=await chromium.launch({headless:!1});const e=(new UserAgent).toString();let o;o=/Mobile|Android/i.test(e)?{width:375,height:667}:/Tablet|iPad/i.test(e)?{width:768,height:1024}:{width:1280,height:800},await fs.promises.mkdir(VIDEO_TMP_DIR,{recursive:!0});const s=await n.newContext({userAgent:e,viewport:o,locale:"en-US",timezoneId:"America/New_York",recordVideo:{dir:VIDEO_TMP_DIR,size:o}}),a=await s.newPage();await a.goto(r,{waitUntil:"domcontentloaded"});const i=await a.content();t.send(i)}catch(e){console.error(e),t.status(500).send("An error occurred while fetching the page")}finally{n&&await n.close()}}),app.get("/thetvapp",(e,t)=>{try{const r=e.query.url;if(!r)return t.status(400).json({status:"error",message:"URL parameter is required."});const n=path.resolve(__dirname,"thetvapp.js");exec(`node "${n}" "${r}"`,{windowsHide:!0},(e,r,n)=>{if(e)return console.error(`Error executing script: ${e.message}`),t.status(500).json({status:"error",message:"Error executing script."});n&&console.error(`Script stderr: ${n}`),console.log(`Script stdout: ${r}`);try{const e=JSON.parse(r.trim());t.json(e)}catch(e){console.error(`Error parsing script output: ${e.message}`),t.status(500).json({status:"error",message:"Error parsing script output."})}})}catch(e){console.error(`Unexpected error: ${e.message}`),t.status(500).json({status:"error",message:"Unexpected error occurred."})}}),app.get("/proxy",async(e,t)=>{const r=!1,n=15e3,o=65536,s=0,a=[];function i(e,t,r){for(const[n,o]of Object.entries(t||{})){const t=n.toLowerCase();r.includes(t)&&(e.removeHeader(n),e.setHeader(n,o))}}try{t.setHeader("Access-Control-Allow-Origin","*");if(function(t){if(!s)return!1;e.app.locals._proxyRateMap||(e.app.locals._proxyRateMap=new Map);const r=e.app.locals._proxyRateMap,n=Date.now(),o=r.get(t)||{count:0,windowStart:n};return n-o.windowStart>=6e4&&(o.count=0,o.windowStart=n),o.count++,r.set(t,o),o.count>s}(e.headers["x-forwarded-for"]?.split(",")[0]?.trim()||e.socket.remoteAddress||"unknown"))return t.status(429).send("Too Many Requests");const u=e.query.data;if(!u)return t.status(400).send("Missing data parameter");let d;try{d=Buffer.from(u,"base64").toString("utf-8")}catch{return t.status(400).send("Invalid base64 data")}const p=d.split("|"),h=e.query.url||e.query.url2||p[0];if(!h)return t.status(400).send("Missing URL");if(!function(e){const t=a;if(!t||!t.length)return!0;try{const r=new URL(e).hostname.toLowerCase();return t.includes(r)}catch{return!1}}(h))return t.status(403).send("Host not allowed");const g={};for(const e of p.slice(1)){if(!e||!e.includes("="))continue;const[t,...r]=e.split("="),n=r.join("=").trim().replace(/^"|"$/g,"");t&&n&&"null"!==n.toLowerCase()&&(g[t.trim()]=n)}["range","authorization"].forEach(t=>{e.headers[t]&&(g[t]=e.headers[t])}),delete g.Range,["connection","keep-alive","proxy-authenticate","proxy-authorization","te","trailers","transfer-encoding","upgrade"].forEach(e=>{delete g[e]});const m=await function(e,t,r="operation"){return new Promise((n,o)=>{const s=setTimeout(()=>{const e=new Error(`${r} timed out after ${t}ms`);e.code="ETIMEDOUT",o(e)},t);e.then(e=>{clearTimeout(s),n(e)},e=>{clearTimeout(s),o(e)})})}(fetchContent(h,g),n,"upstream fetch");r,m.stream.on("error",e=>{t.headersSent||t.status(502),t.destroy(e)});const f=(m.headers["content-type"]||"").toLowerCase(),w=f.includes("video/"),y=/mpegurl|x-mpegurl|vnd\.apple\.mpegurl/.test(f);if(!e.query.key&&w&&!y)return t.setHeader("Access-Control-Allow-Origin","*"),i(t,m.headers,["content-type","content-length","accept-ranges","content-range","cache-control","last-modified","expires","etag"]),t.status(m.statusCode||200),m.stream.pipe(t);if(e.query.key){const e=m.headers["content-length"];if(e&&Number(e)>o)return t.status(413).send("Key too large");const r=await(l=m.stream,c=o,new Promise((e,t)=>{const r=[];let n=0;l.on("data",e=>{if(n+=e.length,n>c)return l.destroy(),t(new Error(`key body exceeded ${c} bytes`));r.push(e)}),l.on("end",()=>e(Buffer.concat(r))),l.on("error",t)}));return t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Content-Type","application/octet-stream"),t.end(r)}if(e.query.url2)return t.setHeader("Access-Control-Allow-Origin","*"),i(t,m.headers,["content-type","content-length","accept-ranges","content-range","cache-control","last-modified","expires","etag"]),m.stream.pipe(t);if(e.query.url){const r=await function(e){return new Promise((t,r)=>{const n=[];e.on("data",e=>n.push(e)),e.on("end",()=>t(Buffer.concat(n))),e.on("error",r)})}(m.stream),n=r.toString("utf-8");if(n.startsWith("#EXTM3U")){const r=rewriteUrls(n,m.finalUrl,`${e.protocol}://${e.headers.host}/proxy`,e.query.data);return t.setHeader("Access-Control-Allow-Origin","*"),t.status(m.statusCode).type("application/x-mpegURL").send(r)}return t.setHeader("Access-Control-Allow-Origin","*"),i(t,m.headers,["content-type","content-length","accept-ranges","content-range","cache-control","last-modified","expires","etag"]),m.stream.pipe(t)}return t.setHeader("Access-Control-Allow-Origin","*"),m.stream.pipe(t)}catch(e){e.response?console.error("[Proxy error]",{url:e.config?.url,status:e.response.status,statusText:e.response.statusText,message:e.message,headers:e.response.headers}):e.request?console.error("[Proxy error - no response]",{url:e.config?.url,message:e.message}):console.error("[Proxy error - setup]",e.message);const r=e&&"ETIMEDOUT"===e.code?504:502;t.setHeader("Access-Control-Allow-Origin","*"),t.status(r).send(504===r?"Upstream timeout":"Upstream request failed")}var l,c}),app.get("/client",(e,t)=>{t.sendFile(path.join(__dirname,"pages","logging.html"))}),app.get("/test-stealth-detection",async(e,t)=>{const r=await launchBrowserByType("Chrome",{stealth:!0}),n=await r.newContext();await hardenBrowserContext(n);const o=await n.newPage(),s=await o.evaluate(()=>({webdriver:navigator.webdriver,hasWebdriverKey:"webdriver"in navigator,isEnumerable:Object.keys(navigator).includes("webdriver")}));await r.close(),t.json(s)}),app.post("/flush-logs",(e,t)=>{fs.truncate(logFilePath,0,e=>{e?(console.error("Error flushing logs:",e),t.status(500).send("Failed to flush logs")):(console.log("Logs flushed successfully"),t.status(200).send("Logs flushed successfully"))})});